<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Listado de Usuarios</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz4YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    </head>
    <body class="bg-white">
        <div class="container-fluid py-4">
            
            <!-- HEADER -->
            <div class="bg-white border rounded-4 shadow-sm p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-1 fw-bold">
                            <i class="bi bi-people-fill text-primary me-2"></i>
                            Gestión de Usuarios
                        </h2>
                        <p class="text-muted mb-0">Administra la información de usuarios del sistema</p>
                    </div>
                    <div class="d-flex gap-2">
                        <a th:href="@{/usuario/form}" class="btn btn-success rounded-3">
                            <i class="bi bi-person-plus-fill me-2"></i>Nuevo Usuario
                        </a>
                        <a th:href="@{/usuario/cargaMasiva}" class="btn btn-primary rounded-3">
                            <i class="bi bi-file-earmark-arrow-up-fill me-2"></i>Carga Masiva
                        </a>
                    </div>
                </div>
            </div>

            <!-- BÚSQUEDA -->
            <div class="bg-white border rounded-4 shadow-sm p-4 mb-4">
                <h5 class="mb-3 fw-semibold">
                    <i class="bi bi-funnel-fill me-2 text-primary"></i>
                    Filtros de Búsqueda
                </h5>
                
                <form th:action="@{/usuario/busqueda}" th:object="${usuarioBusqueda}" method="post">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text"
                                   class="form-control rounded-3"
                                   th:field="*{Nombre}"
                                   placeholder="Nombre">
                        </div>
                        <div class="col-md-3">
                            <input type="text"
                                   class="form-control rounded-3"
                                   th:field="*{ApellidoPaterno}"
                                   placeholder="Apellido Paterno">
                        </div>
                        <div class="col-md-3">
                            <input type="text"
                                   class="form-control rounded-3"
                                   th:field="*{ApellidoMaterno}"
                                   placeholder="Apellido Materno">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" th:field="*{rol.IdRol}" id="rol">
                                <option value="">Todos los roles</option>
                                <option th:each="rol : ${Roles}" th:value="${rol.IdRol}" th:text="${rol.Nombre}"></option>
                            </select>
                        </div>
                        <div class="col-md-1 d-flex gap-2">
                            <button type="submit" class="btn btn-primary rounded-3 w-100">
                                <i class="bi bi-search"></i>
                            </button>
                            <a th:href="@{/usuario}" class="btn btn-outline-secondary rounded-3">
                                <i class="bi bi-arrow-clockwise"></i>
                            </a>
                        </div>
                    </div>
                </form>
            </div>

            <!-- CONTADOR -->
            <div th:unless="${mensajeBusqueda != null || #lists.isEmpty(Usuarios)}" class="mb-3">
                <span class="badge bg-primary rounded-pill fs-6 px-3 py-2">
                    <i class="bi bi-people-fill me-2"></i>
                    <span th:text="${#lists.size(Usuarios)}"></span> usuarios encontrados
                </span>
            </div>

            <!-- ESTADO VACÍO -->
            <div th:if="${mensajeBusqueda != null || #lists.isEmpty(Usuarios)}" 
                 class="bg-white border rounded-4 shadow-sm p-5 text-center">
                <i class="bi bi-inbox display-1 text-muted mb-3"></i>
                <h4 class="text-muted mb-3">No se encontraron usuarios</h4>
                <p class="text-muted mb-4">Intenta ajustar los filtros de búsqueda o limpia los criterios</p>
                <a th:href="@{/usuario}" class="btn btn-primary rounded-3">
                    <i class="bi bi-arrow-clockwise me-2"></i>Ver todos los usuarios
                </a>
            </div>

            <!-- TABLA DE USUARIOS -->
            <div th:unless="${mensajeBusqueda != null || #lists.isEmpty(Usuarios)}" 
                 class="bg-white border rounded-4 shadow-sm overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="py-3 px-4 text-muted fw-semibold small">ACCIONES</th>
                                <th class="py-3 px-4 text-muted fw-semibold small">USUARIO</th>
                                <th class="py-3 px-4 text-muted fw-semibold small">INFORMACIÓN</th>
                                <th class="py-3 px-4 text-muted fw-semibold small">CONTACTO</th>
                                <th class="py-3 px-4 text-muted fw-semibold small">DIRECCIONES</th>
                                <th class="py-3 px-4 text-muted fw-semibold small text-center">ESTADO</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="usuario : ${Usuarios}" class="border-bottom">
                                
                                <!-- ACCIONES -->
                                <td class="py-3 px-4">
                                    <div class="d-flex gap-2 botonesdeaccion">
                                        <a th:href="@{/usuario/detail/{IdUsuario} (IdUsuario = ${usuario.IdUsuario})}" 
                                           class="btn btn-sm btn-outline-warning rounded-3" 
                                           title="Ver detalle">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        <button th:onclick="|EliminarUsuario(${usuario.IdUsuario}, this)|"
                                                class="btnEliminarUsuario btn btn-sm btn-outline-danger rounded-3" 
                                                title="Eliminar">
                                            <i class="bi bi-trash3-fill"></i>
                                        </button>
                                    </div>
                                </td>

                                <!-- USUARIO -->
                                <td class="py-3 px-4">
                                    <div class="d-flex gap-2 mb-2 flex-wrap">
                                        <span class="badge bg-primary rounded-pill">
                                            <i class="bi bi-hash"></i><span th:text="${usuario.IdUsuario}"></span>
                                        </span>
                                        <span th:if="${usuario.Status == 1}" 
                                              class="badge bg-success rounded-pill usuario-status-badge">
                                            <i class="bi bi-check-circle-fill"></i> 
                                            Status <span th:text="${usuario.Status}"></span>
                                        </span>
                                        <span th:if="${usuario.Status == 0}" 
                                              class="badge bg-danger rounded-pill usuario-status-badge">
                                            <i class="bi bi-x-circle-fill"></i> 
                                            Status <span th:text="${usuario.Status}"></span>
                                        </span>
                                    </div>
                                    <div class="fw-bold mb-1" 
                                         th:text="|${usuario.Nombre} ${usuario.ApellidoPaterno} ${usuario.ApellidoMaterno}|"></div>
                                    <div th:switch="${usuario.Status}" class="usuario-status-text">
                                        <small th:case="0" class="text-danger">Cuenta inactiva</small>
                                        <small th:case="1" class="text-success">Cuenta activa</small>
                                    </div>
                                    <small class="text-muted">
                                        <i class="bi bi-person-circle me-1"></i>
                                        <span th:text="${usuario.Username}"></span>
                                    </small>
                                </td>

                                <!-- INFORMACIÓN -->
                                <td class="py-3 px-4">
                                    <div class="mb-2">
                                        <small class="text-muted d-block">
                                            <i class="bi bi-calendar3 me-1"></i>
                                            <span th:text="${usuario.FechaNacimiento}"></span>
                                        </small>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">
                                            <i class="bi bi-gender-ambiguous me-1"></i>
                                            <span th:text="${usuario.Sexo}"></span>
                                        </small>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">
                                            <i class="bi bi-shield-check me-1"></i>
                                            <span th:if="${usuario.Curp != null}" th:text="${usuario.Curp}"></span>
                                            <span th:unless="${usuario.Curp != null}" class="text-danger">Sin CURP</span>
                                        </small>
                                    </div>
                                    <div>
                                        <small class="text-muted">
                                            <i class="bi bi-person-badge me-1"></i>
                                            <span class="badge bg-info rounded-pill" 
                                                  th:if="${usuario.Rol != null}" 
                                                  th:text="${usuario.Rol.Nombre}"></span>
                                            <span class="text-danger" th:unless="${usuario.Rol != null}">Sin Rol</span>
                                        </small>
                                    </div>
                                </td>

                                <!-- CONTACTO -->
                                <td class="py-3 px-4">
                                    <div class="mb-2">
                                        <small class="d-block">
                                            <i class="bi bi-envelope-fill me-1 text-primary"></i>
                                            <span class="text-primary" th:text="${usuario.Email}"></span>
                                        </small>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">
                                            <i class="bi bi-phone-fill me-1"></i>
                                            <span th:if="${usuario.Celular != null}" th:text="${usuario.Celular}"></span>
                                            <span th:unless="${usuario.Celular != null}">Sin celular</span>
                                        </small>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">
                                            <i class="bi bi-telephone-fill me-1"></i>
                                            <span th:if="${usuario.Telefono != null}" th:text="${usuario.Telefono}"></span>
                                            <span th:unless="${usuario.Telefono != null}">Sin teléfono</span>
                                        </small>
                                    </div>
                                </td>

                                <!-- DIRECCIONES -->
                                <td class="py-3 px-4">
                                    <div th:if="${usuario.Direcciones != null && !#lists.isEmpty(usuario.Direcciones)}">
                                        <div th:each="direccion, iterStat : ${usuario.Direcciones}" 
                                             class="mb-2 pb-2"
                                             th:classappend="${!iterStat.last} ? 'border-bottom' : ''">
                                            <small class="d-block">
                                                <i class="bi bi-geo-alt-fill me-1 text-danger"></i>
                                                <span class="fw-semibold" 
                                                      th:text="|${direccion.Calle} ${direccion.NumeroExterior}|"></span>
                                                <span th:if="${direccion.NumeroInterior != null}" 
                                                      th:text="| Int. ${direccion.NumeroInterior}|"></span>
                                            </small>
                                            <small class="text-muted d-block ms-4" 
                                                   th:text="|${direccion.Colonia.Nombre}, ${direccion.Colonia.Municipio.Nombre}, ${direccion.Colonia.Municipio.Estado.Nombre}|"></small>
                                        </div>
                                    </div>
                                    <div th:unless="${usuario.Direcciones != null && !#lists.isEmpty(usuario.Direcciones)}">
                                        <small class="text-muted">Sin direcciones registradas</small>
                                    </div>
                                </td>

                                <!-- ESTADO -->
                                <td class="py-3 px-4 text-center">
                                    <div class="form-check form-switch d-flex justify-content-center">
                                        <input class="form-check-input usuarioIsActive" 
                                               type="checkbox" 
                                               role="switch"
                                               th:checked="${usuario.Status == 1}"
                                               th:onchange="|usuarioIsActive(${usuario.IdUsuario}, this)|">
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        <!-- SCRIPTS -->
        <script th:inline="javascript">
            var jwtToken = [[${jwtToken}]];
            
            const Toast = Swal.mixin({
                toast: true,
                animation: true,
                position: "bottom-end",
                showConfirmButton: false,
                showCloseButton: true,
                timer: 4000,
                timerProgressBar: true,
                didOpen: (toast) => {
                  toast.onmouseenter = Swal.stopTimer;
                  toast.onmouseleave = Swal.resumeTimer;
                }
            });
            
            function EliminarUsuario(IdUsuario, input) {
                Swal.fire({
                    title: "¿Eliminar usuario?",
                    text: "Esta acción no se puede revertir",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#dc3545",
                    cancelButtonColor: "#6c757d",
                    confirmButtonText: "Sí, eliminar",
                    cancelButtonText: "Cancelar"
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: "http://localhost:8080/api/usuario/" + IdUsuario,
                            method: 'DELETE',
                            dataType: 'json',
                            headers: {
                                'Authorization': 'Bearer ' + jwtToken
                            },
                            success: function (data, textStatus, jqXHR) {
                                $(input).parent().closest("tr").remove();
                                Toast.fire({
                                    icon: "success",
                                    title: "Usuario eliminado correctamente"
                                });
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                Toast.fire({
                                    icon: "error",
                                    title: "No se pudo eliminar el usuario"
                                });
                            }
                        });
                    }
                });
            }
            
            $(document).ready(function() {
                $('.usuarioIsActive').each(function() {
                    const checkbox = $(this);
                    const fila = checkbox.closest('tr');
                    const contenido = fila.find('.botonesdeaccion, td:not(:last-child)');
                    
                    if (!checkbox.is(':checked')) {
                        contenido.css({
                            "pointer-events": "none",
                            "opacity": "0.3"
                        });
                    }
                });
            });
            
            function usuarioIsActive(idUsuario, input){
                const $input = $(input);
                const $fila = $input.closest('tr');
                const $contenido = $fila.find('.botonesdeaccion, td:not(:last-child)');
                const $badgeSpan = $fila.find('.usuario-status-badge span');
                const $badge = $fila.find('.usuario-status-badge');
                const $statusText = $fila.find('.usuario-status-text small');

                if ($input.is(':checked')) {
                    let Status = 1;
                    $.ajax({
                        url: "http://localhost:8080/api/usuario/" + idUsuario + "?status=" + Status,
                        method: 'PATCH',
                        dataType: 'json',
                        headers: {
                            'Authorization': 'Bearer ' + jwtToken
                        },
                        success: function (data, textStatus, jqXHR) {
                            if (data.Correct) {
                                $contenido.css({
                                    "pointer-events": "all",
                                    "opacity": "1"
                                });
                                $badgeSpan.text("1");
                                $badge.removeClass("bg-danger").addClass("bg-success")
                                    .html('<i class="bi bi-check-circle-fill"></i> Status 1');
                                $statusText.text("Cuenta activa")
                                    .removeClass("text-danger")
                                    .addClass("text-success");
                                Toast.fire({
                                    icon: "success",
                                    title: "Usuario activado"
                                });
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            $input.prop('checked', false);
                            if (jqXHR.status === 401 || jqXHR.status === 403) {
                                Toast.fire({
                                    icon: "error",
                                    title: "Sesión expirada"
                                });
                                setTimeout(() => window.location.href = '/login', 1500);
                            } else {
                                Toast.fire({
                                    icon: "error",
                                    title: "No se pudo activar el usuario"
                                });
                            }
                        }
                    });
                } else {
                    Swal.fire({
                        title: "¿Desactivar usuario?",
                        text: "El usuario no podrá acceder al sistema",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#dc3545",
                        cancelButtonColor: "#6c757d",
                        confirmButtonText: "Sí, desactivar",
                        cancelButtonText: "Cancelar"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            let Status = 0;
                            $.ajax({
                                url: "http://localhost:8080/api/usuario/" + idUsuario + "?status=" + Status,
                                method: 'PATCH',
                                dataType: 'json',
                                headers: {
                                    'Authorization': 'Bearer ' + jwtToken
                                },
                                success: function (data, textStatus, jqXHR) {
                                    if (data.Correct) {
                                        $contenido.css({
                                            "pointer-events": "none",
                                            "opacity": "0.3"
                                        });
                                        $badgeSpan.text("0");
                                        $badge.removeClass("bg-success").addClass("bg-danger")
                                            .html('<i class="bi bi-x-circle-fill"></i> Status 0');
                                        $statusText.text("Cuenta inactiva")
                                            .removeClass("text-success")
                                            .addClass("text-danger");
                                        Toast.fire({
                                            icon: "success",
                                            title: "Usuario desactivado"
                                        });
                                    }
                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    $input.prop('checked', true);
                                    if (jqXHR.status === 401 || jqXHR.status === 403) {
                                        Toast.fire({
                                            icon: "error",
                                            title: "Sesión expirada"
                                        });
                                        setTimeout(() => window.location.href = '/login', 1500);
                                    } else {
                                        Toast.fire({
                                            icon: "error",
                                            title: "No se pudo desactivar el usuario"
                                        });
                                    }
                                }
                            });
                        } else {
                            $input.prop('checked', true);
                        }
                    });
                }
            }
        </script>
        
        <!-- ALERTAS -->
        <script th:if="${resultDelete}" th:inline="javascript">
            if ([[${resultDelete.Correct}]]){
                Toast.fire({
                    icon: "success",
                    title: [[${resultDelete.Object}]]
                });
            } else {
                Toast.fire({
                    icon: "error",
                    title: [[${resultDelete.Object}]]
                });
            }
        </script>
        <script th:if="${resultAddUserFull}" th:inline="javascript">
            if ([[${resultAddUserFull.Correct}]]){
                Toast.fire({
                    icon: "success",
                    title: [[${resultAddUserFull.Object}]]
                });
            } else {
                Toast.fire({
                    icon: "error",
                    title: [[${resultAddUserFull.Object}]]
                });
            }
        </script>
        <script th:if="${resultCargaMasiva}" th:inline="javascript">
            if ([[${resultCargaMasiva.Correct}]]){
                Toast.fire({
                    icon: "success",
                    title: [[${resultCargaMasiva.Object}]]
                });
            } else {
                Toast.fire({
                    icon: "error",
                    title: [[${resultCargaMasiva.Object}]]
                });
            }
        </script>
    </body>
</html>
